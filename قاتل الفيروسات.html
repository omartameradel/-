<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„Ø¹Ø¨Ø© Ù…Ø¯Ø§ÙØ¹ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">

    <style>
        /* Ø£Ù†Ù…Ø§Ø· CSS Ù„ØªØ­Ø³ÙŠÙ† Ù…Ø¸Ù‡Ø± Ø§Ù„Ù„Ø¹Ø¨Ø© */
        body {
            font-family: 'Cairo', sans-serif;
            overflow-x: hidden;
            overflow-y: auto;
        }
        .game-canvas {
            background: #0a0a2a;
            background-image:
                radial-gradient(circle at 1px 1px, rgba(255,255,255,0.1) 1px, transparent 0),
                radial-gradient(circle at 15px 15px, rgba(255,255,255,0.05) 1px, transparent 0);
            background-size: 30px 30px;
            cursor: crosshair;
            touch-action: none;
        }
        .shield-cooldown-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            transition: height 0.1s linear; pointer-events: none;
        }
        @keyframes screenShake {
            0%, 100% { transform: translate(0, 0) rotate(0deg); }
            10% { transform: translate(-1px, -2px) rotate(-1deg); }
            20% { transform: translate(-3px, 0px) rotate(1deg); }
            30% { transform: translate(3px, 2px) rotate(0deg); }
            40% { transform: translate(1px, -1px) rotate(1deg); }
            50% { transform: translate(-1px, 2px) rotate(-1deg); }
            60% { transform: translate(-3px, 1px) rotate(0deg); }
            70% { transform: translate(3px, 1px) rotate(-1deg); }
            80% { transform: translate(-1px, -1px) rotate(1deg); }
            90% { transform: translate(1px, 2px) rotate(0deg); }
        }
        .shake { animation: screenShake 0.5s; }

        @keyframes glitch {
            2%,64%{ transform: translate(2px,-2px) skew(0deg); }
            4%,60%{ transform: translate(-2px,2px) skew(0deg); }
            62%{ transform: translate(0,0) skew(5deg); }
        }
        .glitch { animation: glitch 1s infinite linear alternate-reverse; filter: invert(1); }

        #hackingMinigame {
            background-color: rgba(0, 20, 30, 0.95);
            border: 2px solid #0ff;
            box-shadow: 0 0 20px #0ff;
        }
        .arrow-key {
            font-size: 2rem;
            padding: 0.5rem 1rem;
            background: #333;
            border: 1px solid #555;
            border-radius: 0.25rem;
            margin: 0 0.25rem;
            color: #fff;
        }
        .arrow-key.correct { background: #0f0; color: #000; }
        .arrow-key.incorrect { background: #f00; color: #000; }
    </style>
</head>

<body class="bg-gray-900 text-white flex flex-col items-center justify-center min-h-screen p-4">

    <div id="game-container" class="w-full max-w-4xl mx-auto flex flex-col lg:flex-row gap-8">

        <div class="flex-grow flex flex-col items-center">

            <h1 class="text-4xl font-bold text-cyan-400 mb-2">Ù…Ø¯Ø§ÙØ¹ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª</h1>
            <p class="text-gray-400 mb-4">Ø§Ù‚Ø¶Ù Ø¹Ù„Ù‰ Ø§Ù„ÙÙŠØ±ÙˆØ³Ø§Øª Ù‚Ø¨Ù„ Ø£Ù† ØªØ³ÙŠØ·Ø± Ø¹Ù„Ù‰ Ø§Ù„Ù†Ø¸Ø§Ù…!</p>

            <div id="canvas-wrapper" class="w-full aspect-w-4 aspect-h-3 relative">
                <canvas id="gameCanvas" class="game-canvas rounded-lg shadow-2xl shadow-cyan-500/20 w-full h-full"></canvas>

                <div id="powerupStatus" class="absolute top-2 left-2 flex gap-2"></div>

                <div id="startScreen" class="absolute inset-0 flex flex-col justify-center items-center bg-black bg-opacity-70">
                    <h2 id="startScreenTitle" class="text-3xl font-bold mb-4">Ù‡Ù„ Ø£Ù†Øª Ù…Ø³ØªØ¹Ø¯ØŸ</h2>
                    <!-- Ø²Ø± Ø¬Ø¯ÙŠØ¯ Ù„Ø¨Ø¯Ø¡ Ù„Ø¹Ø¨Ø© Ø¬Ø¯ÙŠØ¯Ø© -->
                    <button id="startButton" class="bg-cyan-500 hover:bg-cyan-400 text-gray-900 font-bold py-3 px-8 rounded-lg text-xl transition-transform transform hover:scale-105">Ø§Ø¨Ø¯Ø£ Ù„Ø¹Ø¨Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
                    <!-- Ø²Ø± Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø°ÙŠ ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· Ø¹Ù†Ø¯ ÙˆØ¬ÙˆØ¯ Ù†ØªÙŠØ¬Ø© Ø³Ø§Ø¨Ù‚Ø© -->
                    <button id="continueButton" class="bg-purple-600 hover:bg-purple-500 text-white font-bold py-3 px-8 rounded-lg text-xl mt-4 transition-transform transform hover:scale-105 hidden">
                        Ù…ØªØ§Ø¨Ø¹Ø© Ù…Ù† <span id="savedScoreDisplay">0</span> Ù†Ù‚Ø·Ø©
                    </button>
                </div>
                <div id="gameOverScreen" class="absolute inset-0 flex-col justify-center items-center bg-black bg-opacity-70 hidden">
                    <h2 class="text-4xl font-bold text-red-500 mb-2">Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù„Ø¹Ø¨Ø©!</h2>
                    <p class="text-2xl mb-4">Ù†ØªÙŠØ¬ØªÙƒ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©: <span id="finalScore">0</span></p>
                    <div class="flex flex-col gap-4 items-center">
                        <button id="continueAfterDeathButton" class="bg-purple-600 hover:bg-purple-500 text-white font-bold py-3 px-8 rounded-lg text-xl transition-transform transform hover:scale-105 hidden">
                            Ù…ØªØ§Ø¨Ø¹Ø© Ù…Ù† <span id="continueAfterDeathScore">0</span> Ù†Ù‚Ø·Ø©
                        </button>
                    </div>
                </div>

                <div id="hackingMinigame" class="absolute inset-0 flex-col justify-center items-center p-8 rounded-lg hidden">
                    <h2 class="text-3xl font-bold text-red-500 mb-4">!!! Ø§Ø®ØªØ±Ø§Ù‚ ÙÙŠØ±ÙˆØ³ Ù…Ø´ÙØ± !!!</h2>
                    <p class="text-xl text-yellow-400 mb-6">Ø£Ø¯Ø®Ù„ Ø§Ù„ØªØ³Ù„Ø³Ù„ Ø§Ù„ØµØ­ÙŠØ­ Ù„ÙƒØ³Ø± Ø§Ù„Ø­Ù…Ø§ÙŠØ©!</p>
                    <div id="arrowSequence" class="flex mb-6"></div>
                    <p id="minigameStatus" class="text-lg h-8"></p>
                </div>
            </div>

            <div class="w-full flex justify-between items-center mt-4 p-4 bg-gray-800 rounded-lg">
                <div class="text-lg">Ø§Ù„Ù†ØªÙŠØ¬Ø©: <span id="score" class="font-bold text-2xl text-yellow-400">0</span></div>
                <div class="text-lg">Ø§Ù„ÙˆÙ‚Øª: <span id="timer" class="font-bold text-2xl text-yellow-400">60</span></div>
                <div class="relative">
                    <button id="shieldButton" class="bg-purple-600 hover:bg-purple-500 text-white font-bold py-3 px-5 rounded-lg disabled:opacity-50">
                        ğŸ›¡ï¸ Ø¯Ø±Ø¹ Ø³ÙŠØ¨Ø±Ø§Ù†ÙŠ (<span id="shieldsLeft">3</span>)
                    </button>
                    <div id="shieldCooldownOverlay" class="shield-cooldown-overlay rounded-lg" style="height: 0%;"></div>
                </div>
            </div>
        </div>

        <div class="w-full lg:w-1/3 bg-gray-800 p-6 rounded-lg shadow-lg">
            <h2 id="greeting" class="text-2xl font-bold text-cyan-400 mb-2">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ!</h2>
            <button class="mb-4 bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg"><a href="ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„.html">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</a></button>
            <p id="usernameDisplay" class="text-cyan-400 font-bold"></p>

            <h2 class="text-2xl font-bold text-cyan-400 mb-4 border-b-2 border-cyan-500 pb-2" >ğŸ† Ù„ÙˆØ­Ø© Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ†</h2>
            <div id="leaderboard" class="space-y-3"><p class="text-gray-400">ÙŠØªÙ… Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p></div>
            <p class="text-xs text-gray-500 mt-4">Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: <span id="userIdDisplay"></span></p>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import {
            getAuth,
            signInAnonymously,
            onAuthStateChanged,
            signOut
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import {
            getFirestore,
            collection,
            doc,
            getDoc,
            setDoc,
            updateDoc,
            onSnapshot,
            query,
            orderBy
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Ø¹Ù†Ø§ØµØ± ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreEl = document.getElementById('score');
        const timerEl = document.getElementById('timer');
        const startScreen = document.getElementById('startScreen');
        const startScreenTitle = document.getElementById('startScreenTitle');
        const gameOverScreen = document.getElementById('gameOverScreen');
        const startButton = document.getElementById('startButton'); // Ø§Ù„Ø²Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯
        const continueButton = document.getElementById('continueButton');
        const savedScoreDisplay = document.getElementById('savedScoreDisplay');
        const continueAfterDeathButton = document.getElementById('continueAfterDeathButton');
        const continueAfterDeathScoreEl = document.getElementById('continueAfterDeathScore');
        const finalScoreEl = document.getElementById('finalScore');
        const shieldButton = document.getElementById('shieldButton');
        const shieldsLeftEl = document.getElementById('shieldsLeft');
        const shieldCooldownOverlay = document.getElementById('shieldCooldownOverlay');
        const leaderboardEl = document.getElementById('leaderboard');
        const userIdDisplay = document.getElementById('userIdDisplay');
        const powerupStatusEl = document.getElementById('powerupStatus');
        const hackingMinigameEl = document.getElementById('hackingMinigame');
        const arrowSequenceEl = document.getElementById('arrowSequence');
        const minigameStatusEl = document.getElementById('minigameStatus');
        const greetingEl = document.getElementById("greeting");
        const usernameDisplayEl = document.getElementById("usernameDisplay");


let images = {
  lock: new Image(),
  skull: new Image(),
  ant: new Image(),
  ladybug: new Image(),
  spider: new Image(),
  virus: new Image(),
  alien: new Image(),
  worm: new Image()
};

// 2. Ø§Ø³ØªØ®Ø¯Ø§Ù… Data URLs Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ± Ù…Ø¨Ø§Ø´Ø±Ø© (Ù„Ø§ Ø­Ø§Ø¬Ø© Ù„Ù…Ù„ÙØ§Øª Ø®Ø§Ø±Ø¬ÙŠØ©)
// ØµÙˆØ±Ø© Ù‚ÙÙ„ Ø¨Ø³ÙŠØ·Ø©
lockImage.src = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0iY3lhbiIgd2lkdGg9IjY0cHgiIGhlaWdodD0iNjRweCI+PHBhdGggZD0iTTE4IDhoLTFWNmMwLTIuNzYtMi4yNC01LTUtNV M3IDMuMjQgNyA2djJINmMtMS4xIDAtMiAuOS0yIDJ2MTBjMCAxLjEuOSAyIDIgMmgxMmMxLjEgMCAyLS45IDItMlYxMGMwLTEuMS0uOS0yLTItMnpNOSAxMEg5VjZjMC0xLjY2IDEuMzQtMyAzLTNzMyAxLjM0IDMgM3YySDl6Ii8+PC9zdmc+';
// ØµÙˆØ±Ø© Ø¬Ù…Ø¬Ù…Ø© Ø¨Ø³ÙŠØ·Ø©
skullImage.src = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0icmVkIiB3aWR0aD0iNjRweCIgaGVpZ2h0PSI2NHB4Ij48cGF0aCBkPSJNMCAwaDI0djI0SDBWMjR6IiBmaWxsPSJub25lIi8+PHBhdGggZD0iTTEyIDJDNi40NyAyIDIgNi40NyAyIDEyczQuNDcgMTAgMTAgMTBzMTAtNC40NyAxMC0xMFMxNy41MyAyIDEyIDJ6bTAgMThjLTQuNDEgMC04LTMuNTktOC04czMuNTktOCA4LTggOCA0IDggOC0zLjU5IDgtOCA4em0zLjUtOWMtLjgzIDAtMS41LS42Ny0xLjUtMS41UzE0LjY3IDggMTUuNSA4czEuNS42NyAxLjUgMS41LS42NyAxLjUtMS41IDEuNXptLTcgMGMtLjgzIDAtMS41LS42Ny0xLjUtMS41UzcuNjcgOCA4LjUgOHMxLjUuNjcgMS41IDEuNS0uNjcgMS41LTEuNSAxLjV6bTMuNSA1Yy0yLjMzIDAtNC4zMS0xLjQ2LTUuMTItMy41aDEwLjI0Yy0uODIgMi4wNC0yLjggMy41LTUuMTIgMy41eiIvPjwvc3ZnPg==';
antImage.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjRweCIgaGVpZ2h0PSI2NHB4IiB2aWV3Qm94PSIwIDAgMjQgMjQiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHRleHQgeD0iMTAiIHk9IjIwIiBmb250LXNpemU9IjE2IiBmaWxsPSIjMzMwMDIwIj7wn5GJPC90ZXh0Pjwvc3ZnPg==';
ladybugImage.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjRweCIgaGVpZ2h0PSI2NHB4IiB2aWV3Qm94PSIwIDAgMjQgMjQiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHRleHQgeD0iMTAiIHk9IjIwIiBmb250LXNpemU9IjE2IiBmaWxsPSIjQ0YwMDAwIj7wn5GKPC90ZXh0Pjwvc3ZnPg==';
spiderImage.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjRweCIgaGVpZ2h0PSI2NHB4IiB2aWV3Qm94PSIwIDAgMjQgMjQiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHRleHQgeD0iMTAiIHk9IjIwIiBmb250LXNpemU9IjE2IiBmaWxsPSIjMzMzMzMzIj7wn5GUPC90ZXh0Pjwvc3ZnPg==';
virusImage.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjRweCIgaGVpZ2h0PSI2NHB4IiB2aWV3Qm94PSIwIDAgMjQgMjQiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHRleHQgeD0iMTAiIHk9IjIwIiBmb250LXNpemU9IjE2IiBmaWxsPSIjMDA4ODAwIj7wn5GdPC90ZXh0Pjwvc3ZnPg==';
alienImage.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjRweCIgaGVpZ2h0PSI2NHB4IiB2aWV3Qm94PSIwIDAgMjQgMjQiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHRleHQgeD0iMTAiIHk9IjIwIiBmb250LXNpemU9IjE2IiBmaWxsPSIjODAwMGY4Ij7wn5KfPC90ZXh0Pjwvc3ZnPg==';
wormImage.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjRweCIgaGVpZ2h0PSI2NHB4IiB2aWV3Qm94PSIwIDAgMjQgMjQiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHRleHQgeD0iMTAiIHk9IjIwIiBmb250LXNpemU9IjE2IiBmaWxsPSIjN0QzMzAwIj7wn5GAPC90ZXh0Pjwvc3ZnPg==';

let loaded = 0;
let total = Object.keys(sources).length;



// 3. Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„ØµÙˆØ± Ù‚Ø¯ ØªÙ… ØªØ­Ù…ÙŠÙ„Ù‡Ø§ Ù‚Ø¨Ù„ ØªÙØ¹ÙŠÙ„ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù„Ø¹Ø¨Ø©
let imagesLoaded = 0;
const totalImages = 2;
startButton.disabled = true;
continueButton.disabled = true;

function onImageLoad() {
    imagesLoaded++;
    if (imagesLoaded === totalImages) {
        startButton.disabled = false;
        continueButton.disabled = false;
        console.log("All game images loaded successfully!");
    }
}

lockImage.onload = onImageLoad;
skullImage.onload = onImageLoad;
lockImage.onerror = () => console.error("Failed to load lock image.");
skullImage.onerror = () => console.error("Failed to load skull image.");





        // --- Ø¥Ø¹Ø¯Ø§Ø¯ Firebase ---
        let db, auth, userId, savedScore = 0;
        const firebaseConfig = {
            apiKey: "AIzaSyD4B49RUOXRXcW9S7Nv4puz9m7QKoAa_tE",
            authDomain: "programomartamer-451a5.firebaseapp.com",
            projectId: "programomartamer-451a5",
            storageBucket: "programomartamer-451a5.firebase.app",
            messagingSenderId: "351835913301",
            appId: "1:351835913301:web:d722fdcc9fb7b15c4468dc",
            measurementId: "G-R5FJQY220K"
        };
        let scoreSavingInterval; 
        
        // ØªÙ‡ÙŠØ¦Ø© Firebase ÙˆØ§Ù„Ù…Ø³ØªÙ…Ø¹ÙŠÙ†
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            setupAuthListener();
            setupLeaderboardListener();
        } catch (error) {
            console.error("Firebase initialization failed:", error);
            leaderboardEl.innerHTML = '<p class="text-red-500">ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.</p>';
        }

        // ÙŠØ³ØªÙ…Ø¹ Ù„ØªØºÙŠØ±Ø§Øª Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© (ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„/Ø§Ù„Ø®Ø±ÙˆØ¬)
        async function setupAuthListener() {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    userIdDisplay.textContent = userId;
                    const username = sessionStorage.getItem("username");
                    usernameDisplayEl.textContent = username ? username : "!";
                    greetingEl.textContent = username ? `Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ ${username}!` : "Ù…Ø±Ø­Ø¨Ø§Ù‹!";
                    await fetchSavedScore();
                } else {
                    signInAnonymously(auth); // ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ù…Ø¬Ù‡ÙˆÙ„ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ Ù…Ø³ØªØ®Ø¯Ù…
                }
            });
        }
        

        
        for (let key in images) {
  images[key].src = sources[key];
  images[key].onload = () => {
    loaded++;
    if (loaded === total) {
      console.log("âœ… ÙƒÙ„ Ø§Ù„ØµÙˆØ± Ø§ØªØ­Ù…Ù„Øª");

      // Ø§Ø±Ø³Ù… Ø¨Ø¹Ø¯ Ù…Ø§ ÙƒÙ„Ù‡ ÙŠØ¨Ù‚Ù‰ Ø¬Ø§Ù‡Ø²
      ctx.drawImage(images.lock,   20,  20, 64, 64);
      ctx.drawImage(images.skull,  100, 20, 64, 64);
      ctx.drawImage(images.ant,    180, 20, 64, 64);
      ctx.drawImage(images.ladybug,260, 20, 64, 64);
      ctx.drawImage(images.spider, 340, 20, 64, 64);
      ctx.drawImage(images.virus,  420, 20, 64, 64);
      ctx.drawImage(images.alien,  500, 20, 64, 64);
      ctx.drawImage(images.worm,   20, 120,64, 64);
    }
  };
}


        // Ø¬Ù„Ø¨ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© Ù…Ù† Firestore
        async function fetchSavedScore() {
            if (!userId) return;
            const userRef = doc(db, "leaderboard", userId);
            try {
                const docSnap = await getDoc(userRef);
                if (docSnap.exists() && docSnap.data().score > 0) {
                    savedScore = docSnap.data().score;
                    savedScoreDisplay.textContent = savedScore;
                    continueButton.classList.remove('hidden');
                    startButton.classList.add('hidden'); // Ø¥Ø®ÙØ§Ø¡ Ø²Ø± Ø§Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ø¬Ø¯ÙŠØ¯
                    startScreenTitle.textContent = "ØªØ§Ø¨Ø¹ Ù„Ø¹Ø¨ØªÙƒ";
                } else {
                    savedScore = 0;
                    continueButton.classList.add('hidden');
                    startButton.classList.remove('hidden'); // Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± Ø§Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ø¬Ø¯ÙŠØ¯
                    startScreenTitle.textContent = "Ù‡Ù„ Ø£Ù†Øª Ù…Ø³ØªØ¹Ø¯ØŸ";
                }
            } catch (e) {
                console.error("Error fetching saved score:", e);
                savedScore = 0;
                continueButton.classList.add('hidden');
                startButton.classList.remove('hidden');
                startScreenTitle.textContent = "Ù‡Ù„ Ø£Ù†Øª Ù…Ø³ØªØ¹Ø¯ØŸ";
            }
        }
        
        // Ø¯Ø§Ù„Ø© Ù„Ø­ÙØ¸ Ø§Ù„Ù†ØªÙŠØ¬Ø© ÙÙŠ Firestore
        async function saveScoreToFirestore(name, currentScore) {
            if (!userId) return; // Ù„Ø§ ØªÙØ¹Ù„ Ø´ÙŠØ¦Ù‹Ø§ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ Ù…Ø¹Ø±Ù Ù…Ø³ØªØ®Ø¯Ù…
            const userRef = doc(db, "leaderboard", userId);
            
            try {
                await setDoc(userRef, {
                    name: name,
                    score: currentScore,
                    userId: userId
                });
            } catch (e) {
                console.error("Error saving score:", e);
            }
        }

        // Ø¯Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ø­ÙØ¸ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ù†ØªÙŠØ¬Ø©
        function startScoreSaving() {
            if (scoreSavingInterval) clearInterval(scoreSavingInterval);
            scoreSavingInterval = setInterval(() => {
                if (gameActive && !gamePaused) {
                    const username = sessionStorage.getItem("username") || "Ù…Ø¬Ù‡ÙˆÙ„";
                    saveScoreToFirestore(username, score);
                }
            }, 5000); // Ø§Ù„Ø­ÙØ¸ ÙƒÙ„ 5 Ø«ÙˆØ§Ù†ÙŠ
        }
        
        // ÙŠØ³ØªÙ…Ø¹ Ù„ØªØºÙŠØ±Ø§Øª Ù„ÙˆØ­Ø© Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ† ÙˆÙŠØ­Ø¯Ø« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
        function setupLeaderboardListener() {
            try {
                const q = query(collection(db, "leaderboard"), orderBy("score", "desc"));
                onSnapshot(q, (querySnapshot) => {
                    let html = '';
                    let rank = 1;
                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        html += `
                            <div class="flex justify-between items-center bg-gray-700 p-3 rounded-lg">
                                <span>${escapeHTML(data.name)}</span>
                                <span class="font-bold text-yellow-400">${data.score}</span>
                            </div>
                        `;
                        rank++;
                    });
                    leaderboardEl.innerHTML = html;
                });
            } catch (error) {
                console.error("Failed to load leaderboard:", error);
                leaderboardEl.innerHTML = '<p class="text-red-500">ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ù„ÙˆØ­Ø© Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ†.</p>';
            }
        }

        // --- Ø­Ø§Ù„Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© ---
        let score, timer, gameInterval, spawnTimeout, shieldsLeft;
        let viruses = [], particles = [], powerUps = [];
        let activePowerUps = {};
        let shieldCooldown = 5000, isShieldOnCooldown = false;
        let gameActive = false, gamePaused = false, bossActive = false, minigameActive = false;
        let nextBossScore = 500;
        
        // --- ØªØ¹Ø±ÙŠÙØ§Øª Ø§Ù„Ù„Ø¹Ø¨Ø© ---
        const virusTypes = [
            { emoji: 'ğŸ›', size: 20, speed: 1, points: 10, color: '#a3e635' },
            { emoji: 'ğŸœ', size: 15, speed: 2, points: 20, color: '#facc15' },
            { emoji: 'ğŸ', size: 25, speed: 0.8, points: 15, color: '#ef4444' },
            { emoji: 'ğŸ•·ï¸', size: 22, speed: 1.5, points: 30, color: '#a855f7' },
            { emoji: 'ğŸ¦ ', size: 30, speed: 0.5, points: 50, color: '#22d3ee' },
            { emoji: 'ğŸ‘¾', size: 25, speed: 1, points: -50, color: '#9333ea', isGlitched: true },
        ];
        const bossType = { emoji: 'ğŸ’€', size: 60, speed: 0.5, points: 500, color: '#ff0000', health: 10, maxHealth: 10 };
        const encryptedVirusType = { emoji: 'ğŸ”’', size: 30, speed: 0.7, points: 0, color: '#0ff', isEncrypted: true };
        const powerUpTypes = {
            slowMo: { emoji: 'â„ï¸', duration: 5000, color: '#3b82f6' },
            multiShot: { emoji: 'â˜„ï¸', duration: 10000, color: '#f97316' },
            timeBonus: { emoji: 'â³', color: '#10b981' },
        };

        // --- Ù…Ø­Ø±Ùƒ Ø§Ù„ØµÙˆØª (Ù…Ø¨Ø³Ø·) ---
        let audioCtx;
        function initAudio() { if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }
        function playSound(type) { initAudio(); }

        // --- Ø­Ù„Ù‚Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ---
        function initializeGame(initialScore) {
            initAudio();
            score = initialScore;
            timer = 60;
            shieldsLeft = 3;
            viruses = []; particles = []; powerUps = []; activePowerUps = {};
            isShieldOnCooldown = false; gameActive = true; gamePaused = false; bossActive = false; minigameActive = false;
            nextBossScore = 500;
            
            scoreEl.textContent = score;
            timerEl.textContent = timer;
            shieldsLeftEl.textContent = shieldsLeft;
            shieldButton.disabled = false;
            shieldCooldownOverlay.style.height = '0%';
            startScreen.style.display = 'none';
            gameOverScreen.classList.add('hidden');
            hackingMinigameEl.classList.add('hidden');
            canvas.classList.remove('glitch');
            continueAfterDeathButton.classList.add('hidden'); // Ø¥Ø®ÙØ§Ø¡ Ø²Ø± Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© ÙÙŠ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ù„Ø¹Ø¨Ø©

            gameInterval = setInterval(() => {
                if (gamePaused) return;
                timer--;
                timerEl.textContent = timer;
                if (timer <= 0) endGame();
            }, 1000);

            startScoreSaving(); // Ø¨Ø¯Ø¡ Ø§Ù„Ø­ÙØ¸ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ù†ØªÙŠØ¬Ø©
            scheduleNextSpawn();
            animate();
        }

        function endGame() {
            playSound('gameOver');
            gameActive = false;
            clearInterval(gameInterval);
            clearInterval(scoreSavingInterval); // Ø¥ÙŠÙ‚Ø§Ù Ù…Ø¤Ù‚Øª Ø§Ù„Ø­ÙØ¸
            clearTimeout(spawnTimeout);
            finalScoreEl.textContent = score;
            continueAfterDeathScoreEl.textContent = score;
            continueAfterDeathButton.classList.remove('hidden'); // Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©
            gameOverScreen.classList.remove('hidden');
            const username = sessionStorage.getItem("username") || "Ù…Ø¬Ù‡ÙˆÙ„";
            saveScoreToFirestore(username, score); // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø­ÙØ¸ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
        }
        
        function pauseGame() { gamePaused = true; }
        function resumeGame() { gamePaused = false; }

        // --- Ù…Ù†Ø·Ù‚ Ø¸Ù‡ÙˆØ± Ø§Ù„ÙÙŠØ±ÙˆØ³Ø§Øª ---
        function scheduleNextSpawn() {
            if (!gameActive) return;
            const spawnRate = Math.max(200, 1000 - score / 2);
            spawnTimeout = setTimeout(() => {
                if (gamePaused) {
                    scheduleNextSpawn();
                    return;
                }
                const rand = Math.random();
                if (score >= nextBossScore && !bossActive) {
                    spawnBoss();
                    nextBossScore += 500;
                } else if (rand < 0.03 && !minigameActive) {
                    spawnItem(encryptedVirusType);
                } else if (rand < 0.1) {
                    spawnItem(Object.values(powerUpTypes)[Math.floor(Math.random() * 3)], true);
                } else {
                    spawnVirus(); // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù„ØªÙˆÙ„ÙŠØ¯ Ù…Ø¬Ù…ÙˆØ¹Ø© Ù…Ù† Ø§Ù„ÙÙŠØ±ÙˆØ³Ø§Øª
                }
                scheduleNextSpawn();
            }, spawnRate);
        }

        function spawnVirus() {
            if (bossActive) return;
            const numToSpawn = Math.floor(Math.random() * 3) + 1; // ØªÙˆÙ„ÙŠØ¯ Ù…Ù† 1 Ø¥Ù„Ù‰ 3 ÙÙŠØ±ÙˆØ³Ø§Øª ÙÙŠ ÙƒÙ„ Ù…Ø±Ø©
            for (let i = 0; i < numToSpawn; i++) {
                const type = virusTypes[Math.floor(Math.random() * virusTypes.length)];
                spawnItem(type);
            }
        }

        function spawnBoss() {
            bossActive = true;
            spawnItem({ ...bossType, health: bossType.maxHealth });
        }
        
        function spawnItem(item, isPowerUp = false) {
            // ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ÙÙŠØ±ÙˆØ³ ÙÙŠ Ù…ÙƒØ§Ù† Ø¹Ø´ÙˆØ§Ø¦ÙŠ Ù‚Ø±ÙŠØ¨ Ù…Ù† Ø§Ù„Ø£Ø¹Ù„Ù‰
            const x = Math.random() * (canvas.width - item.size * 2) + item.size;
            const y = -item.size - Math.random() * 50; // Ù„Ø¬Ø¹Ù„Ù‡Ø§ ØªØ¸Ù‡Ø± Ù…Ù† Ø®Ø§Ø±Ø¬ Ø§Ù„Ø´Ø§Ø´Ø©
            const angle = Math.random() * Math.PI * 0.5 + Math.PI * 0.25;
            const speed = (item.speed || 1) + (score / 1000);
            const entity = {
                x, y,
                dx: Math.cos(angle) * speed * (activePowerUps.slowMo ? 0.3 : 1),
                dy: Math.sin(angle) * speed * (activePowerUps.slowMo ? 0.3 : 1),
                ...item
            };
            if (isPowerUp) powerUps.push(entity);
            else viruses.push(entity);
        }
        
        // --- Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ù„Ø§Ø¹Ø¨ ÙˆÙ‚ÙˆÙ‰ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ---
        function useShield() {
            if (shieldsLeft > 0 && !isShieldOnCooldown && gameActive && !gamePaused) {
                playSound('shield');
                shieldsLeft--;
                shieldsLeftEl.textContent = shieldsLeft;
                isShieldOnCooldown = true;
                shieldButton.disabled = true;
                
                const originalViruses = [...viruses];
                viruses = []; // Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙÙŠØ±ÙˆØ³Ø§Øª
                
                let cooldownTime = shieldCooldown;
                const cooldownInterval = setInterval(() => {
                    cooldownTime -= 100;
                    shieldCooldownOverlay.style.height = `${(cooldownTime / shieldCooldown) * 100}%`;
                    if (cooldownTime <= 0) {
                        clearInterval(cooldownInterval);
                        isShieldOnCooldown = false;
                        shieldButton.disabled = false;
                        shieldCooldownOverlay.style.height = '0%';
                    }
                }, 100);
            }
        }

        function activatePowerUp(type) {
            const id = type.emoji;
            if (activePowerUps[id]) clearTimeout(activePowerUps[id].timeout);

            if (id === 'â³') {
                timer += 5;
                timerEl.textContent = timer;
                return;
            }

            activePowerUps[id] = {
                duration: type.duration,
                expire: Date.now() + type.duration
            };

            activePowerUps[id].timeout = setTimeout(() => {
                delete activePowerUps[id];
            }, type.duration);
        }

        // --- Ø§Ù„Ù„Ø¹Ø¨Ø© Ø§Ù„Ù…ØµØºØ±Ø© Ù„Ù„Ø§Ø®ØªØ±Ø§Ù‚ ---
        let minigameSequence = [];
        let playerSequenceIndex = 0;

        function startHackingMinigame() {
            pauseGame();
            minigameActive = true;
            hackingMinigameEl.classList.remove('hidden');
            minigameStatusEl.textContent = '';
            
            const arrows = ['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'];
            const symbols = { 'ArrowUp': 'â†‘', 'ArrowDown': 'â†“', 'ArrowLeft': 'â†', 'ArrowRight': 'â†’' };
            minigameSequence = Array.from({ length: 5 }, () => arrows[Math.floor(Math.random() * 4)]);
            playerSequenceIndex = 0;
            
            arrowSequenceEl.innerHTML = minigameSequence.map(key => `<div id="key-${key}" class="arrow-key">${symbols[key]}</div>`).join('');
            
            window.addEventListener('keydown', handleMinigameKeys);
        }

        function handleMinigameKeys(e) {
            const key = e.key;
            if (!['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].includes(key)) return;

            const correctKey = minigameSequence[playerSequenceIndex];
            const keyEl = arrowSequenceEl.children[playerSequenceIndex];

            if (key === correctKey) {
                keyEl.classList.add('correct');
                playerSequenceIndex++;
                if (playerSequenceIndex === minigameSequence.length) {
                    minigameStatusEl.textContent = 'ØªÙ… Ø§Ù„Ø§Ø®ØªØ±Ø§Ù‚! +500 Ù†Ù‚Ø§Ø·ØŒ +10 Ø«ÙˆØ§Ù†ÙŠ';
                    minigameStatusEl.classList.add('text-green-400');
                    score += 500;
                    timer += 10;
                    scoreEl.textContent = score;
                    timerEl.textContent = timer;
                    endMinigame(true);
                }
            } else {
                keyEl.classList.add('incorrect');
                minigameStatusEl.textContent = 'ÙØ´Ù„ Ø§Ù„Ø§Ø®ØªØ±Ø§Ù‚! -5 Ø«ÙˆØ§Ù†ÙŠ';
                minigameStatusEl.classList.add('text-red-400');
                timer -= 5;
                timerEl.textContent = timer;
                endMinigame(false);
            }
        }

        function endMinigame(success) {
            window.removeEventListener('keydown', handleMinigameKeys);
            setTimeout(() => {
                hackingMinigameEl.classList.add('hidden');
                minigameStatusEl.className = 'text-lg h-8';
                minigameActive = false;
                resumeGame();
            }, 1500);
        }

        // --- Ø§Ù„Ø±Ø³Ù… ÙˆØ§Ù„ØªØ­Ø±ÙŠÙƒ ---
        function animate() {
            if (!gameActive) return;
            requestAnimationFrame(animate);
            if (gamePaused) return;

            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            viruses.forEach((v, i) => {
                v.dy = v.dy > 0 ? Math.abs(v.dy) * (activePowerUps.slowMo ? 0.3 : 1) : -Math.abs(v.dy) * (activePowerUps.slowMo ? 0.3 : 1);
                v.x += v.dx; v.y += v.dy;
                if (v.x - v.size < 0 || v.x + v.size > canvas.width) v.dx *= -1;
                
                if (v.y > canvas.height + v.size * 2) {
                    viruses.splice(i, 1);
                    if (!v.health) {
                        score -= Math.floor(v.points * 0.5);
                        if (score < 0) score = 0;
                        scoreEl.textContent = score;
                    }
                }
                
                ctx.save();
                ctx.font = `${v.size * 1.5}px "Segoe UI Emoji", "Apple Color Emoji", sans-serif`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.globalAlpha = v.emoji === 'ğŸ‘»' ? 0.5 : 1;
                if (v.emoji === 'ğŸ”’') {
    // Ø§Ø±Ø³Ù… ØµÙˆØ±Ø© Ø§Ù„Ù‚ÙÙ„ Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ
    ctx.drawImage(lockImage, v.x - v.size, v.y - v.size, v.size * 2, v.size * 2);
} else if (v.emoji === 'ğŸ’€') {
    // Ø§Ø±Ø³Ù… ØµÙˆØ±Ø© Ø§Ù„Ø¬Ù…Ø¬Ù…Ø©
    ctx.drawImage(skullImage, v.x - v.size, v.y - v.size, v.size * 2, v.size * 2);
} else {
    // Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù„Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ
    ctx.fillText(v.emoji, v.x, v.y);
}
                
                if (v.health) {
                    const healthBarWidth = v.size * 2;
                    const healthBarHeight = 5;
                    const healthPercentage = v.health / v.maxHealth;
                    const healthColor = healthPercentage > 0.6 ? '#22c55e' : healthPercentage > 0.3 ? '#eab308' : '#ef4444';
                    
                    ctx.fillStyle = '#333';
                    ctx.fillRect(v.x - healthBarWidth / 2, v.y - v.size * 1.5 - 10, healthBarWidth, healthBarHeight);
                    
                    ctx.fillStyle = healthColor;
                    ctx.fillRect(v.x - healthBarWidth / 2, v.y - v.size * 1.5 - 10, healthBarWidth * healthPercentage, healthBarHeight);
                }
                
                ctx.restore();
            });

            powerUps.forEach((p, i) => {
                p.dy = (p.speed || 1) * (activePowerUps.slowMo ? 0.3 : 1);
                p.y += p.dy;
                if (p.y - p.size > canvas.height) powerUps.splice(i, 1);
                ctx.font = `${30}px sans-serif`;
                ctx.fillText(p.emoji, p.x, p.y);
            });

            particles.forEach((p, i) => {
                p.x += p.vx;
                p.y += p.vy;
                p.alpha -= p.fade;
                if (p.alpha <= 0) {
                    particles.splice(i, 1);
                } else {
                    ctx.fillStyle = `rgba(${p.color}, ${p.alpha})`;
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, p.radius, 0, Math.PI * 2);
                    ctx.fill();
                }
            });

            powerupStatusEl.innerHTML = '';
            for (const id in activePowerUps) {
                const remaining = Math.ceil((activePowerUps[id].expire - Date.now()) / 1000);
                powerupStatusEl.innerHTML += `<div class="bg-black bg-opacity-50 p-2 rounded-lg text-2xl">${id} ${remaining}s</div>`;
            }

            // ... (Ø¯Ø§Ø®Ù„ Ø¯Ø§Ù„Ø© animate)
if (v.emoji === 'ğŸ”’') {
    // Ø§Ø±Ø³Ù… ØµÙˆØ±Ø© Ø§Ù„Ù‚ÙÙ„ Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ
    // Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø± Ø³ÙŠØ¹Ù…Ù„ Ø§Ù„Ø¢Ù† Ø¨Ù†Ø¬Ø§Ø­
    ctx.drawImage(lockImage, v.x - v.size, v.y - v.size, v.size * 2, v.size * 2);
} else if (v.emoji === 'ğŸ’€') {
    // Ø§Ø±Ø³Ù… ØµÙˆØ±Ø© Ø§Ù„Ø¬Ù…Ø¬Ù…Ø©
    // Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø± Ø³ÙŠØ¹Ù…Ù„ Ø§Ù„Ø¢Ù† Ø¨Ù†Ø¬Ø§Ø­
    ctx.drawImage(skullImage, v.x - v.size, v.y - v.size, v.size * 2, v.size * 2);
} else {
    // Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù„Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ
    ctx.fillText(v.emoji, v.x, v.y);
}

        }
        
        // --- Ù…Ø¹Ø§Ù„Ø¬ Ø§Ù„Ù†Ù‚Ø± ---
        function handleCanvasClick(event) {
            if (!gameActive || gamePaused) return;
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            let clientX, clientY;
            if (event.touches) {
                if (event.touches.length > 0) { clientX = event.touches[0].clientX; clientY = event.touches[0].clientY; }
                else { return; }
            } else { clientX = event.clientX; clientY = event.clientY; }
            const x = (clientX - rect.left) * scaleX;
            const y = (clientY - rect.top) * scaleY;
            
            const shots = activePowerUps.multiShot ? [{x,y}, {x:x-20, y:y+20}, {x:x+20, y:y+20}] : [{x,y}];

            shots.forEach(shot => {
                for (let i = viruses.length - 1; i >= 0; i--) {
                    const virus = viruses[i];
                    const distance = Math.sqrt((shot.x - virus.x)**2 + (shot.y - virus.y)**2);
                    if (distance < virus.size) {
                        const username = sessionStorage.getItem("username") || "Ù…Ø¬Ù‡ÙˆÙ„";
                        if (virus.isEncrypted) {
                            startHackingMinigame();
                            viruses.splice(i, 1);
                        } else if (virus.isGlitched) {
                            canvas.classList.add('glitch');
                            setTimeout(() => canvas.classList.remove('glitch'), 2000);
                            score += virus.points;
                            viruses.splice(i, 1);
                        } else if (virus.health) {
                            virus.health--;
                            if (virus.health <= 0) {
                                score += virus.points;
                                viruses.splice(i, 1);
                                bossActive = false;
                            }
                        } else {
                            score += virus.points;
                            viruses.splice(i, 1);
                        }
                        scoreEl.textContent = score;
                        return;
                    }
                }
                for (let i = powerUps.length - 1; i >= 0; i--) {
                    const p = powerUps[i];
                    const distance = Math.sqrt((shot.x - p.x)**2 + (shot.y - p.y)**2);
                    if (distance < 20) {
                        const typeKey = Object.keys(powerUpTypes).find(key => powerUpTypes[key].emoji === p.emoji);
                        activatePowerUp(powerUpTypes[typeKey]);
                        powerUps.splice(i, 1);
                        return;
                    }
                }
            });
        }

        // --- Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© ÙˆÙ…Ø³ØªÙ…Ø¹ÙŠ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« ---
        function escapeHTML(str) {
            return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
        }
        
        function setCanvasDimensions() {
            const wrapper = document.getElementById('canvas-wrapper');
            const style = getComputedStyle(wrapper);
            const width = parseInt(style.width, 10);
            const height = width * 0.75;
            canvas.width = width;
            canvas.height = height;
        }
        
        // Ù…Ø³ØªÙ…Ø¹Ùˆ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ù„Ù„Ø£Ø²Ø±Ø§Ø± ÙˆØ§Ù„Ù„ÙˆØ­Ø©
        window.addEventListener('resize', setCanvasDimensions);
        startButton.addEventListener('click', () => initializeGame(0));
        continueButton.addEventListener('click', () => initializeGame(savedScore));
        continueAfterDeathButton.addEventListener('click', () => initializeGame(score));
        shieldButton.addEventListener('click', useShield);
        canvas.addEventListener('click', handleCanvasClick);
        canvas.addEventListener('touchstart', (e) => { e.preventDefault(); handleCanvasClick(e); }, { passive: false });
        
        // --- Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø£ÙˆÙ„ÙŠ ---
        setCanvasDimensions();
    </script>
</body>
</html>
