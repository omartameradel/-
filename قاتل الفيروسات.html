<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>لعبة مدافع الإنترنت</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Cairo', sans-serif; overflow-x:hidden; }
    .game-canvas {
      background: #0a0a2a;
      background-image:
        radial-gradient(circle at 1px 1px, rgba(255,255,255,0.1) 1px, transparent 0),
        radial-gradient(circle at 15px 15px, rgba(255,255,255,0.05) 1px, transparent 0);
      background-size: 30px 30px;
      cursor: crosshair;
      touch-action: none;
    }
    .shield-cooldown-overlay {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background-color: rgba(0,0,0,0.5); transition: height 0.1s linear; pointer-events:none;
    }
    #hackingMinigame .arrow-key { /* style if needed */ }
  </style>
</head>
<body class="bg-gray-900 text-white flex flex-col items-center justify-center min-h-screen p-4">

  <div id="game-container" class="w-full max-w-4xl mx-auto flex flex-col lg:flex-row gap-8">
    <div class="flex-grow flex flex-col items-center">
      <h1 class="text-4xl font-bold text-cyan-400 mb-2">مدافع الإنترنت</h1>
      <p class="text-gray-400 mb-4">اقضِ على الفيروسات قبل أن تسيطر على النظام!</p>
      <div id="canvas-wrapper" class="w-full relative">
        <canvas id="gameCanvas" class="game-canvas rounded-lg shadow-2xl shadow-cyan-500/20 w-full"></canvas>
        <div id="powerupStatus" class="absolute top-2 left-2 flex gap-2"></div>
        <div id="startScreen" class="absolute inset-0 flex flex-col justify-center items-center bg-black bg-opacity-70">
          <h2 id="startScreenTitle" class="text-3xl font-bold mb-4">هل أنت مستعد؟</h2>
          <button id="startButton" class="bg-cyan-500 hover:bg-cyan-400 text-gray-900 font-bold py-3 px-8 rounded-lg text-xl transition-transform hover:scale-105">ابدأ لعبة جديدة</button>
          <button id="continueButton" class="bg-purple-600 hover:bg-purple-500 text-white font-bold py-3 px-8 rounded-lg text-xl mt-4 transition-transform hover:scale-105 hidden">
            متابعة من <span id="savedScoreDisplay">0</span> نقطة
          </button>
        </div>
        <div id="gameOverScreen" class="absolute inset-0 flex-col justify-center items-center bg-black bg-opacity-70 hidden">
          <h2 class="text-4xl font-bold text-red-500 mb-2">انتهت اللعبة!</h2>
          <p class="text-2xl mb-4">نتيجتك النهائية: <span id="finalScore">0</span></p>
          <div class="flex flex-col gap-4 items-center">
            <button id="continueAfterDeathButton" class="bg-purple-600 hover:bg-purple-500 text-white font-bold py-3 px-8 rounded-lg text-xl transition-transform hover:scale-105 hidden">
              متابعة من <span id="continueAfterDeathScore">0</span> نقطة
            </button>
          </div>
        </div>
        <div id="hackingMinigame" class="absolute inset-0 flex-col justify-center items-center p-8 rounded-lg hidden">
          <h2 class="text-3xl font-bold text-red-500 mb-4">!!! اختراق فيروس مشفر !!!</h2>
          <p class="text-xl text-yellow-400 mb-6">أدخل التسلسل الصحيح لكسر الحماية!</p>
          <div id="arrowSequence" class="flex mb-6"></div>
          <p id="minigameStatus" class="text-lg h-8"></p>
        </div>
      </div>
      <div class="w-full flex justify-between items-center mt-4 p-4 bg-gray-800 rounded-lg">
        <div class="text-lg">النتيجة: <span id="score" class="font-bold text-2xl text-yellow-400">0</span></div>
        <div class="text-lg">الوقت: <span id="timer" class="font-bold text-2xl text-yellow-400">60</span></div>
        <div class="relative">
          <button id="shieldButton" class="bg-purple-600 hover:bg-purple-500 text-white font-bold py-3 px-5 rounded-lg disabled:opacity-50">
            🛡️ درع سيبراني (<span id="shieldsLeft">3</span>)
          </button>
          <div id="shieldCooldownOverlay" class="shield-cooldown-overlay rounded-lg" style="height: 0%;"></div>
        </div>
      </div>
    </div>
    <div class="w-full lg:w-1/3 bg-gray-800 p-6 rounded-lg shadow-lg">
      <h2 id="greeting" class="text-2xl font-bold text-cyan-400 mb-2">مرحباً بك!</h2>
      <button class="mb-4 bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg"><a href="تسجيل الدخول.html">تسجيل الخروج</a></button>
      <p id="usernameDisplay" class="text-cyan-400 font-bold"></p>
      <h2 class="text-2xl font-bold text-cyan-400 mb-4 border-b-2 border-cyan-500 pb-2">🏆 لوحة المتصدرين</h2>
      <div id="leaderboard" class="space-y-3"><p class="text-gray-400">يتم التحميل...</p></div>
      <p class="text-xs text-gray-500 mt-4">معرف المستخدم: <span id="userIdDisplay"></span></p>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, doc, getDoc, setDoc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // DOM-e
    const canvas = document.getElementById('gameCanvas'), ctx = canvas.getContext('2d');
    const scoreEl = document.getElementById('score'), timerEl = document.getElementById('timer');
    const startScreen = document.getElementById('startScreen'), startButton = document.getElementById('startButton'), continueButton = document.getElementById('continueButton');
    const savedScoreDisplay = document.getElementById('savedScoreDisplay'), gameOverScreen = document.getElementById('gameOverScreen');
    const finalScoreEl = document.getElementById('finalScore'), continueAfterDeathButton = document.getElementById('continueAfterDeathButton'), continueAfterDeathScoreEl = document.getElementById('continueAfterDeathScore');
    const shieldButton = document.getElementById('shieldButton'), shieldsLeftEl = document.getElementById('shieldsLeft'), shieldCooldownOverlay = document.getElementById('shieldCooldownOverlay');
    const leaderboardEl = document.getElementById('leaderboard'), userIdDisplay = document.getElementById('userIdDisplay');
    const powerupStatusEl = document.getElementById('powerupStatus'), hackingMinigameEl = document.getElementById('hackingMinigame');
    const arrowSequenceEl = document.getElementById('arrowSequence'), minigameStatusEl = document.getElementById('minigameStatus');
    const greetingEl = document.getElementById('greeting'), usernameDisplayEl = document.getElementById('usernameDisplay');

    // Firebase config (صحّح storageBucket)
    const firebaseConfig = {
      apiKey: "AIzaSyD4B49RUOXRXcW9S7Nv4puz9m7QKoAa_tE",
      authDomain: "programomartamer-451a5.firebaseapp.com",
      projectId: "programomartamer-451a5",
      storageBucket: "programomartamer-451a5.appspot.com",
      messagingSenderId: "351835913301",
      appId: "1:351835913301:web:d722fdcc9fb7b15c4468dc",
      measurementId: "G-R5FJQY220K"
    };

    let db, auth, userId, savedScore = 0, scoreSavingInterval;
    try {
      const app = initializeApp(firebaseConfig);
      db = getFirestore(app);
      auth = getAuth(app);
      setupAuthListener();
      setupLeaderboardListener();
    } catch (e) {
      console.error("Firebase init error", e);
      leaderboardEl.innerHTML = '<p class="text-red-500">فشل الاتصال بقاعدة البيانات.</p>';
    }

    onAuthStateChanged(auth, user => {
      if (user) {
        userId = user.uid; userIdDisplay.textContent = userId;
        const username = sessionStorage.getItem("username") || "مجهول";
        usernameDisplayEl.textContent = username; greetingEl.textContent = `مرحباً، ${username}!`;
        fetchSavedScore();
      } else signInAnonymously(auth);
    });

    async function fetchSavedScore() {
      if (!userId) return;
      try {
        const docSnap = await getDoc(doc(db, "leaderboard", userId));
        if (docSnap.exists() && docSnap.data().score > 0) {
          savedScore = docSnap.data().score;
          savedScoreDisplay.textContent = savedScore;
          continueButton.classList.remove('hidden');
          startButton.classList.add('hidden');
          document.getElementById('startScreenTitle').textContent = "تابع لعبتك";
        }
      } catch (e) { console.error("fetch score error", e); }
    }

    async function saveScoreToFirestore(name, currentScore) {
      if (!userId) return;
      try { await setDoc(doc(db, "leaderboard", userId), { name, score: currentScore, userId }); }
      catch (e) { console.error("save score error", e); }
    }

    function startScoreSaving() {
      clearInterval(scoreSavingInterval);
      scoreSavingInterval = setInterval(() => {
        if (gameActive && !gamePaused) {
          const uname = sessionStorage.getItem("username") || "مجهول";
          saveScoreToFirestore(uname, score);
        }
      }, 5000);
    }

    function setupLeaderboardListener() {
      try {
        const q = query(collection(db, "leaderboard"), orderBy("score", "desc"));
        onSnapshot(q, snap => {
          let html = '';
          snap.forEach(docSnap => {
            const d = docSnap.data();
            html += `<div class="flex justify-between items-center bg-gray-700 p-3 rounded-lg">
                       <span>${escapeHTML(d.name)}</span>
                       <span class="font-bold text-yellow-400">${d.score}</span>
                     </div>`;
          });
          leaderboardEl.innerHTML = html;
        });
      } catch (e) {
        console.error("leaderboard listener error", e);
        leaderboardEl.innerHTML = '<p class="text-red-500">فشل في تحميل لوحة المتصدرين.</p>';
      }
    }

    // لعبة – الإيموجي فقط (بدون صور)
    const virusTypes = [
      { emoji: '🐛', size: 20, speed: 1, points: 10 },
      { emoji: '🐜', size: 15, speed: 2, points: 20 },
      { emoji: '🐞', size: 25, speed: 0.8, points: 15 },
      { emoji: '🕷️', size: 22, speed: 1.5, points: 30 },
      { emoji: '🦠', size: 30, speed: 0.5, points: 50 },
      { emoji: '👾', size: 25, speed: 1, points: -50, isGlitched: true }
    ];
    const bossType = { emoji: '💀', size: 60, speed: 0.5, points: 500, health: 10, maxHealth: 10 };
    const encryptedVirusType = { emoji: '🔒', size: 30, speed: 0.7, points: 0, isEncrypted: true };
    const powerUpTypes = { slowMo: { emoji: '❄️', duration: 5000 }, multiShot: { emoji: '☄️', duration: 10000 }, timeBonus: { emoji: '⏳' } };

    let score = 0, timer = 60, shieldsLeft = 3;
    let viruses = [], powerUps = [], activePowerUps = {};
    let shieldCooldown = 5000, isShieldOnCooldown = false;
    let gameActive = false, gamePaused = false, bossActive = false, minigameActive = false;
    let nextBossScore = 500;

    window.addEventListener('resize', setCanvasDimensions);
    startButton.addEventListener('click', () => initializeGame(0));
    continueButton.addEventListener('click', () => initializeGame(savedScore));
    continueAfterDeathButton.addEventListener('click', () => initializeGame(score));
    shieldButton.addEventListener('click', useShield);
    canvas.addEventListener('click', handleCanvasClick);

    setCanvasDimensions();

    function setCanvasDimensions() {
      const w = canvas.parentElement.clientWidth;
      canvas.width = w;
      canvas.height = w * 0.75;
    }

    function initializeGame(initialScore) {
      score = initialScore; timer = 60; shieldsLeft = 3;
      scoreEl.textContent = score; timerEl.textContent = timer; shieldsLeftEl.textContent = shieldsLeft;
      gameActive = true; gamePaused = false; bossActive = false; minigameActive = false; nextBossScore = 500;
      startScreen.style.display = 'none'; gameOverScreen.classList.add('hidden');
      hackingMinigameEl.classList.add('hidden'); canvas.classList.remove('glitch');
      clearInterval(scoreSavingInterval);
      startScoreSaving();
      gameInterval = setInterval(() => {
        if (!gamePaused) {
          timer--; timerEl.textContent = timer;
          if (timer <= 0) endGame();
        }
      }, 1000);
      scheduleNextSpawn();
      animate();
    }

    function endGame() {
      gameActive = false; clearInterval(gameInterval); clearInterval(scoreSavingInterval);
      finalScoreEl.textContent = score; continueAfterDeathScoreEl.textContent = score;
      continueAfterDeathButton.classList.remove('hidden');
      gameOverScreen.classList.remove('hidden');
      const uname = sessionStorage.getItem("username") || "مجهول";
      saveScoreToFirestore(uname, score);
    }

    function scheduleNextSpawn() {
      if (!gameActive) return;
      const rate = Math.max(200, 1000 - score / 2);
      setTimeout(() => {
        if (!gamePaused) {
          if (score >= nextBossScore && !bossActive) { spawnBoss(); nextBossScore += 500; }
          else if (Math.random() < 0.03 && !minigameActive) spawnItem(encryptedVirusType);
          else if (Math.random() < 0.1) spawnItem(Object.values(powerUpTypes)[Math.floor(Math.random()*3)], true);
          else spawnVirus();
        }
        scheduleNextSpawn();
      }, rate);
    }

    function spawnVirus() {
      if (bossActive) return;
      const count = Math.floor(Math.random()*3)+1;
      for (let i = 0; i < count; i++) {
        spawnItem(virusTypes[Math.floor(Math.random()*virusTypes.length)]);
      }
    }

    function spawnBoss() { bossActive = true; spawnItem({ ...bossType }); }

    function spawnItem(type, isPowerUp = false) {
      const x = Math.random() * (canvas.width - type.size*2) + type.size;
      const y = -type.size - Math.random()*50;
      const angle = Math.random()*Math.PI*0.5 + Math.PI*0.25;
      const speed = (type.speed || 1) + (score/1000);
      const factor = activePowerUps['❄️'] ? 0.3 : 1;
      const entity = { x, y, dx: Math.cos(angle)*speed*factor, dy: Math.sin(angle)*speed*factor, ...type };
      if (isPowerUp) powerUps.push(entity); else viruses.push(entity);
    }

    function useShield() {
      if (shieldsLeft > 0 && !isShieldOnCooldown && gameActive && !gamePaused) {
        shieldsLeft--; shieldsLeftEl.textContent = shieldsLeft;
        isShieldOnCooldown = true; shieldButton.disabled = true;
        viruses = [];
        let cooldown = shieldCooldown;
        const interval = setInterval(() => {
          cooldown -= 100;
          shieldCooldownOverlay.style.height = `${(cooldown/shieldCooldown)*100}%`;
          if (cooldown <= 0) {
            clearInterval(interval);
            isShieldOnCooldown = false;
            shieldButton.disabled = false;
            shieldCooldownOverlay.style.height = '0%';
          }
        }, 100);
      }
    }

    function activatePowerUp(type) {
      if (type.emoji === '⏳') {
        timer += 5; timerEl.textContent = timer;
        return;
      }
      if (activePowerUps[type.emoji]) clearTimeout(activePowerUps[type.emoji].timeout);
      activePowerUps[type.emoji] = { expire: Date.now()+type.duration };
      activePowerUps[type.emoji].timeout = setTimeout(() => {
        delete activePowerUps[type.emoji];
      }, type.duration);
    }

    let minigameSequence = [], playerIndex = 0;
    function startHackingMinigame() {
      gamePaused = true; minigameActive = true;
      hackingMinigameEl.classList.remove('hidden');
      minigameStatusEl.textContent = '';
      const arrows = ['ArrowUp','ArrowDown','ArrowLeft','ArrowRight'];
      const symbols = { ArrowUp:'↑',ArrowDown:'↓',ArrowLeft:'←',ArrowRight:'→' };
      minigameSequence = Array.from({ length: 5 }, () => arrows[Math.floor(Math.random()*4)]);
      playerIndex = 0;
      arrowSequenceEl.innerHTML = minigameSequence.map(k => `<div class="arrow-key">${symbols[k]}</div>`).join('');
      window.addEventListener('keydown', handleMinigameKeys);
    }

    function handleMinigameKeys(e) {
      const key = e.key;
      if (!['ArrowUp','ArrowDown','ArrowLeft','ArrowRight'].includes(key)) return;
      const correct = minigameSequence[playerIndex];
      const keyEl = arrowSequenceEl.children[playerIndex];
      if (key === correct) {
        keyEl.classList.add('correct'); playerIndex++;
        if (playerIndex === minigameSequence.length) {
          minigameStatusEl.textContent = 'تم الاختراق! +500 نقاط، +10 ثواني';
          score += 500; timer += 10; scoreEl.textContent = score; timerEl.textContent = timer;
          endMinigame(true);
        }
      } else {
        keyEl.classList.add('incorrect');
        minigameStatusEl.textContent = 'فشل الاختراق! -5 ثواني';
        timer -= 5; timerEl.textContent = timer;
        endMinigame(false);
      }
    }

    function endMinigame(success) {
      window.removeEventListener('keydown', handleMinigameKeys);
      setTimeout(() => {
        hackingMinigameEl.classList.add('hidden');
        minigameStatusEl.className = 'text-lg h-8';
        minigameActive = false; gamePaused = false;
      }, 1500);
    }

    function handleCanvasClick(e) {
      if (!gameActive || gamePaused) return;
      const rect = canvas.getBoundingClientRect();
      const x = (e.clientX - rect.left) * canvas.width / rect.width;
      const y = (e.clientY - rect.top) * canvas.height / rect.height;
      const shots = activePowerUps['☄️'] ? [{x,y},{x-20,y+20},{x+20,y+20}] : [{x,y}];
      shots.forEach(shot => {
        for (let i = viruses.length-1; i >= 0; i--) {
          const v = viruses[i];
          const dist = Math.hypot(shot.x - v.x, shot.y - v.y);
          if (dist < v.size) {
            if (v.isEncrypted) { startHackingMinigame(); viruses.splice(i,1); }
            else if (v.isGlitched) { canvas.classList.add('glitch'); setTimeout(() => canvas.classList.remove('glitch'),2000); score += v.points; viruses.splice(i,1); }
            else if (v.health) { v.health--; if (v.health<=0) { score+=v.points; viruses.splice(i,1); bossActive=false; } }
            else { score += v.points; viruses.splice(i,1); }
            scoreEl.textContent = score; return;
          }
        }
        for (let i = powerUps.length-1; i >= 0; i--) {
          const p = powerUps[i];
          const dist = Math.hypot(shot.x - p.x, shot.y - p.y);
          if (dist < 20) {
            const typeKey = Object.keys(powerUpTypes).find(k => powerUpTypes[k].emoji === p.emoji);
            activatePowerUp(powerUpTypes[typeKey]);
            powerUps.splice(i,1);
            return;
          }
        }
      });
    }

    function animate() {
      if (!gameActive) return;
      requestAnimationFrame(animate);
      if (gamePaused) return;
      ctx.clearRect(0,0,canvas.width,canvas.height);

      viruses.forEach((v,i) => {
        v.y += v.dy; v.x += v.dx;
        if (v.x - v.size < 0 || v.x + v.size > canvas.width) v.dx *= -1;
        if (v.y > canvas.height + v.size*2) { viruses.splice(i,1); score = Math.max(0, score - Math.floor(v.points * 0.5)); scoreEl.textContent = score; return; }

        ctx.save();
        ctx.font = `${v.size * 1.5}px "Segoe UI Emoji", "Apple Color Emoji", sans-serif`;
        ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
        v.emoji === '👻' ? ctx.globalAlpha = 0.5 : ctx.globalAlpha = 1;
        ctx.fillText(v.emoji, v.x, v.y);

        if (v.health) {
          const w = v.size*2, h = 5, pct = v.health / v.maxHealth;
          const col = pct > 0.6 ? '#22c55e' : pct > 0.3 ? '#eab308' : '#ef4444';
          ctx.fillStyle = '#333'; ctx.fillRect(v.x - w/2, v.y - v.size*1.5 - 10, w, h);
          ctx.fillStyle = col; ctx.fillRect(v.x - w/2, v.y - v.size*1.5 - 10, w*pct, h);
        }
        ctx.restore();
      });

      powerUps.forEach((p,i) => {
        p.y += (p.speed || 1) * (activePowerUps['❄️'] ? 0.3 : 1);
        if (p.y - p.size > canvas.height) return powerUps.splice(i,1);
        ctx.font = `30px sans-serif`;
        ctx.fillText(p.emoji, p.x, p.y);
      });

      powerupStatusEl.innerHTML = "";
      for (const k in activePowerUps) {
        const remaining = Math.ceil((activePowerUps[k].expire - Date.now())/1000);
        powerupStatusEl.innerHTML += `<div class="bg-black bg-opacity-50 p-2 rounded-lg text-2xl">${k} ${remaining}s</div>`;
      }
    }

    function escapeHTML(s){ return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,"&#039;"); }
  </script>
</body>
</html>
