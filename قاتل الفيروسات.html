<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لعبة مدافع الإنترنت</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Cairo', sans-serif; overflow-x: hidden; overflow-y: auto; }
        .game-canvas {
            background: #0a0a2a;
            background-image: radial-gradient(circle at 1px 1px, rgba(255,255,255,0.1) 1px, transparent 0),
                radial-gradient(circle at 15px 15px, rgba(255,255,255,0.05) 1px, transparent 0);
            background-size: 30px 30px;
            cursor: crosshair;
            touch-action: none;
        }
        .shield-cooldown-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            transition: height 0.1s linear; pointer-events: none;
        }
        .shake { animation: screenShake 0.5s; }
        @keyframes screenShake {
            0%, 100% { transform: translate(0, 0) rotate(0deg); }
            10% { transform: translate(-1px, -2px) rotate(-1deg); }
            20% { transform: translate(-3px, 0px) rotate(1deg); }
            30% { transform: translate(3px, 2px) rotate(0deg); }
            40% { transform: translate(1px, -1px) rotate(1deg); }
            50% { transform: translate(-1px, 2px) rotate(-1deg); }
            60% { transform: translate(-3px, 1px) rotate(0deg); }
            70% { transform: translate(3px, 1px) rotate(-1deg); }
            80% { transform: translate(-1px, -1px) rotate(1deg); }
            90% { transform: translate(1px, 2px) rotate(0deg); }
        }
        @keyframes glitch {
            2%,64%{ transform: translate(2px,-2px) skew(0deg); }
            4%,60%{ transform: translate(-2px,2px) skew(0deg); }
            62%{ transform: translate(0,0) skew(5deg); }
        }
        .glitch { animation: glitch 1s infinite linear alternate-reverse; filter: invert(1); }
        #hackingMinigame {
            background-color: rgba(0, 20, 30, 0.95);
            border: 2px solid #0ff;
            box-shadow: 0 0 20px #0ff;
        }
        .arrow-key {
            font-size: 2rem;
            padding: 0.5rem 1rem;
            background: #333;
            border: 1px solid #555;
            border-radius: 0.25rem;
            margin: 0 0.25rem;
            color: #fff;
        }
        .arrow-key.correct { background: #0f0; color: #000; }
        .arrow-key.incorrect { background: #f00; color: #000; }
    </style>
</head>
<body class="bg-gray-900 text-white flex flex-col items-center justify-center min-h-screen p-4">

    <div id="game-container" class="w-full max-w-4xl mx-auto flex flex-col lg:flex-row gap-8">

        <div class="flex-grow flex flex-col items-center">

            <h1 class="text-4xl font-bold text-cyan-400 mb-2">مدافع الإنترنت</h1>
            <p class="text-gray-400 mb-4">اقضِ على الفيروسات قبل أن تسيطر على النظام!</p>
            
            <div id="canvas-wrapper" class="w-full aspect-w-4 aspect-h-3 relative">
                <canvas id="gameCanvas" class="game-canvas rounded-lg shadow-2xl shadow-cyan-500/20 w-full h-full"></canvas>
                
                <div id="powerupStatus" class="absolute top-2 left-2 flex gap-2"></div>

                <div id="startScreen" class="absolute inset-0 flex flex-col justify-center items-center bg-black bg-opacity-70">
                    <h2 class="text-3xl font-bold mb-4">هل أنت مستعد؟</h2>
                    <div class="mb-4 text-xl text-yellow-400">نقاطك الحالية: <span id="currentPoints">0</span></div>
                    <button id="continueButton" class="bg-cyan-500 hover:bg-cyan-400 text-gray-900 font-bold py-3 px-8 rounded-lg text-xl transition-transform transform hover:scale-105" style="display:none;">تكملة على النقاط</button>
                    <button id="startNewButton" class="bg-green-500 hover:bg-green-400 text-gray-900 font-bold py-3 px-8 rounded-lg text-xl transition-transform transform hover:scale-105" style="display:none;">ابدأ لعبة جديدة</button>
                </div>
                <div id="gameOverScreen" class="absolute inset-0 flex flex-col justify-center items-center bg-black bg-opacity-70 hidden">
                    <h2 class="text-4xl font-bold text-red-500 mb-2">انتهت اللعبة!</h2>
                    <p class="text-2xl mb-4">نتيجتك النهائية: <span id="finalScore">0</span></p>
                    <div class="mb-4 text-xl text-yellow-400">نقاطك الحالية: <span id="currentPointsEnd">0</span></div>
                    <button id="continueButtonEnd" class="bg-cyan-500 hover:bg-cyan-400 text-gray-900 font-bold py-3 px-8 rounded-lg text-xl transition-transform transform hover:scale-105">تكملة على النقاط</button>
                </div>

                <div id="hackingMinigame" class="absolute inset-0 flex-col justify-center items-center p-8 rounded-lg hidden">
                    <h2 class="text-3xl font-bold text-red-500 mb-4">!!! اختراق فيروس مشفر !!!</h2>
                    <p class="text-xl text-yellow-400 mb-6">أدخل التسلسل الصحيح لكسر الحماية!</p>
                    <div id="arrowSequence" class="flex mb-6"></div>
                    <p id="minigameStatus" class="text-lg h-8"></p>
                </div>
            </div>

            <div class="w-full flex justify-between items-center mt-4 p-4 bg-gray-800 rounded-lg">
                <div class="text-lg">النتيجة: <span id="score" class="font-bold text-2xl text-yellow-400">0</span></div>
                <div class="text-lg">الوقت: <span id="timer" class="font-bold text-2xl text-yellow-400">60</span></div>
                <div class="relative">
                    <button id="shieldButton" class="bg-purple-600 hover:bg-purple-500 text-white font-bold py-3 px-5 rounded-lg disabled:opacity-50">
                        🛡️ درع سيبراني (<span id="shieldsLeft">3</span>)
                    </button>
                    <div id="shieldCooldownOverlay" class="shield-cooldown-overlay rounded-lg" style="height: 0%;"></div>
                </div>
            </div>
        </div>

        <div class="w-full lg:w-1/3 bg-gray-800 p-6 rounded-lg shadow-lg">
            <h2 id="greeting" class="text-2xl font-bold text-cyan-400 mb-2">مرحباً بك!</h2>
            <button class="mb-4 bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg"><a href="تسجيل الدخول.html">تسجيل الخروج</a></button>
            <p id="usernameDisplay" class="text-cyan-400 font-bold"></p>

            <h2 class="text-2xl font-bold text-cyan-400 mb-4 border-b-2 border-cyan-500 pb-2" >🏆 لوحة المتصدرين</h2>
            <div id="leaderboard" class="space-y-3"><p class="text-gray-400">يتم التحميل...</p></div>
            <p class="text-xs text-gray-500 mt-4">معرف المستخدم: <span id="userIdDisplay"></span></p>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import {
            getAuth,
            signInAnonymously,
            onAuthStateChanged,
            signOut
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import {
            getFirestore,
            collection,
            doc,
            getDoc,
            setDoc,
            updateDoc,
            onSnapshot,
            query,
            orderBy,
            limit
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- DOM ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreEl = document.getElementById('score');
        const timerEl = document.getElementById('timer');
        const startScreen = document.getElementById('startScreen');
        const gameOverScreen = document.getElementById('gameOverScreen');
        const finalScoreEl = document.getElementById('finalScore');
        const shieldButton = document.getElementById('shieldButton');
        const shieldsLeftEl = document.getElementById('shieldsLeft');
        const shieldCooldownOverlay = document.getElementById('shieldCooldownOverlay');
        const leaderboardEl = document.getElementById('leaderboard');
        const userIdDisplay = document.getElementById('userIdDisplay');
        const powerupStatusEl = document.getElementById('powerupStatus');
        const hackingMinigameEl = document.getElementById('hackingMinigame');
        const arrowSequenceEl = document.getElementById('arrowSequence');
        const minigameStatusEl = document.getElementById('minigameStatus');
        const greetingEl = document.getElementById("greeting");
        const usernameDisplayEl = document.getElementById("usernameDisplay");
        const continueButton = document.getElementById('continueButton');
        const startNewButton = document.getElementById('startNewButton');
        const currentPointsEl = document.getElementById('currentPoints');
        const continueButtonEnd = document.getElementById('continueButtonEnd');
        const currentPointsEndEl = document.getElementById('currentPointsEnd');

        // --- Firebase ---
        let db, auth, userId;
        let userScore = 0; // محفوظ في Firestore
        let roundScore = 0; // نقاط الجولة الحالية

        const firebaseConfig = {
            apiKey: "AIzaSyD4B49RUOXRXcW9S7Nv4puz9m7QKoAa_tE",
            authDomain: "programomartamer-451a5.firebaseapp.com",
            projectId: "programomartamer-451a5",
            storageBucket: "programomartamer-451a5.firebasestorage.app",
            messagingSenderId: "351835913301",
            appId: "1:351835913301:web:d722fdcc9fb7b15c4468dc",
            measurementId: "G-R5FJQY220K"
        };

        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            setupAuthListener();
            setupLeaderboardListener();
        } catch (err) {
            console.error("Firebase init failed:", err);
            leaderboardEl.innerHTML = '<p class="text-red-500">فشل الاتصال.</p>';
        }

        // --- Auth ---
        function setupAuthListener() {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    userIdDisplay.textContent = userId;

                    const username = sessionStorage.getItem("username") || "لاعب مجهول";
                    usernameDisplayEl.textContent = username;
                    greetingEl.textContent = `مرحباً، ${username}!`;

                    // جلب أو إنشاء مستند اللاعب (doc id = uid). نخزن uid أيضاً كحقل للحماية من أخطاء سابقة.
                    const userRef = doc(db, "leaderboard", userId);
                    const snap = await getDoc(userRef);
                    if (snap.exists()) {
                        const data = snap.data() || {};
                        userScore = data.score || 0;
                    } else {
                        userScore = 0;
                        await setDoc(userRef, { uid: userId, name: username, score: 0 }, { merge: true });
                    }

                    updateScoreUI();

                    // أظهر الأزرار المناسبة
                    if (userScore > 0) {
                        continueButton.style.display = "block";
                        startNewButton.style.display = "none";
                    } else {
                        continueButton.style.display = "none";
                        startNewButton.style.display = "block";
                    }
                } else {
                    // تسجيل دخول مجهول إذا لم يكن هناك مستخدم
                    signInAnonymously(auth).catch(e => console.error("anon sign-in failed:", e));
                }
            });
        }
        // --- Initialize ---
        // --- Initialize audio (placeholder) ---                           
        // --- Update score UI ---                          
        function updateScoreUI() {
            scoreEl.textContent = userScore + roundScore;
            currentPointsEl.textContent = userScore;
            currentPointsEndEl.textContent = userScore;
        }

        // --- Save score (يحفظ أعلى مجموع: saved || finalTotal) ---
        async function saveScore(finalTotal) {
            if (!userId) return;
            const username = sessionStorage.getItem("username") || "لاعب مجهول";
            const userRef = doc(db, "leaderboard", userId);
            const snap = await getDoc(userRef);
            const old = snap.exists() ? (snap.data().score || 0) : 0;
            const newSaved = Math.max(old, finalTotal);
            if (newSaved > old) {
                await updateDoc(userRef, { uid: userId, name: username, score: newSaved });
            } else {
                // ensure uid/name exist
                await setDoc(userRef, { uid: userId, name: username }, { merge: true });
            }
            userScore = newSaved;
            updateScoreUI();
        }

        // --- Leaderboard listener ---
        function setupLeaderboardListener() {
            try {
                const q = query(collection(db, "leaderboard"), orderBy("score", "desc"), limit(50));
                onSnapshot(q, (qs) => {
                    const rows = [];
                    qs.forEach(d => {
                        const data = d.data() || {};
                        rows.push({ docId: d.id, uid: data.uid || d.id, name: data.name || 'لاعب', score: data.score || 0 });
                    });

                    // ترتيب تأكيدي
                    rows.sort((a,b) => b.score - a.score);

                    let last = null, rank = 0;
                    let html = '';
                    let userRank = null;
                    rows.forEach((r, i) => {
                        if (r.score !== last) rank = i + 1;
                        const isMe = r.uid === userId;
                        if (isMe) userRank = rank;
                        const highlight = isMe ? 'bg-cyan-600 bg-opacity-30 border border-cyan-400' : 'bg-gray-700';
                        html += `
                            <div class="flex justify-between items-center ${highlight} p-3 rounded-lg transition-colors duration-200">
                                <div>
                                    <div>${rank}. ${escapeHTML(r.name)}</div>
                                    <div class="text-xs text-gray-400">ID: ${escapeHTML(r.uid)}</div>
                                </div>
                                <span class="font-bold text-yellow-400">${r.score}</span>
                            </div>
                        `;
                        last = r.score;
                    });

                    leaderboardEl.innerHTML = html + (userRank ? `<div class="mt-4 text-lg text-cyan-400">ترتيبك الحالي: <span class="font-bold">${userRank}</span></div>` : '');
                });
            } catch (e) {
                console.error("Leaderboard listen error:", e);
                leaderboardEl.innerHTML = '<p class="text-red-500">فشل في تحميل لوحة المتصدرين.</p>';
            }
        }

        // --- Game logic (مبسط مع فصل نقاط الجولة) ---
        let timer = 60, gameInterval, spawnTimeout, shieldsLeft = 3;
        let viruses = [], particles = [], powerUps = [];
        let activePowerUps = {}, shieldCooldown = 5000, isShieldOnCooldown = false;
        let gameActive = false, gamePaused = false, bossActive = false, minigameActive = false, nextBossScore = 500;

        const virusTypes = [
            { emoji: '🐛', size: 20, speed: 1, points: 10 },
            { emoji: '🐜', size: 15, speed: 2, points: 20 },
            { emoji: '🐞', size: 25, speed: 0.8, points: 15 },
            { emoji: '🕷', size: 22, speed: 1.5, points: 30 },
            { emoji: '🦠', size: 30, speed: 0.5, points: 50 },
            { emoji: '👾', size: 25, speed: 1, points: -50, isGlitched: true },
        ];
        const bossType = { emoji: '💀', size: 60, speed: 0.5, points: 500, health: 10, maxHealth: 10 };
        const encryptedVirusType = { emoji: '🔒', size: 30, speed: 0.7, points: 0, isEncrypted: true };
        const powerUpTypes = {
            slowMo: { emoji: '❄', duration: 5000 },
            multiShot: { emoji: '☄', duration: 10000 },
            timeBonus: { emoji: '⏳' },
        };

        function initAudio() {}
        function playSound() {}

        function startGame() {
            if (!userId) {
                alert("الرجاء الانتظار حتى يتم تسجيل الدخول...");
                return;
            }
            roundScore = 0;
            timer = 60;
            shieldsLeft = 3;
            viruses = []; particles = []; powerUps = []; activePowerUps = {};
            isShieldOnCooldown = false; gameActive = true; gamePaused = false; bossActive = false; minigameActive = false;
            nextBossScore = 500;
            shieldsLeftEl.textContent = shieldsLeft;
            shieldButton.disabled = false;
            shieldCooldownOverlay.style.height = '0%';
            startScreen.style.display = 'none';
            gameOverScreen.classList.add('hidden');
            hackingMinigameEl.classList.add('hidden');
            canvas.classList.remove('glitch');

            scoreEl.textContent = userScore + roundScore;
            timerEl.textContent = timer;

            gameInterval = setInterval(() => {
                if (gamePaused) return;
                timer--;
                timerEl.textContent = timer;
                if (timer <= 0) endGame();
            }, 1000);

            scheduleNextSpawn();
            animate();
        }

        function endGame() {
            gameActive = false;
            clearInterval(gameInterval);
            clearTimeout(spawnTimeout);
            const total = userScore + roundScore;
            finalScoreEl.textContent = total;
            gameOverScreen.classList.remove('hidden');
            // احفظ الاحتمال الأعلى: إذا كانت النتيجة النهائية أعلى من المحفوظ
            saveScore(total).catch(e => console.error(e));
        }

        // --- Create fresh anonymous user helper ---
        async function createNewAnonymousUser() {
            const oldUid = userId || null;
            try {
                await signOut(auth);
            } catch (e) {
                console.warn("signOut failed (may be no user):", e);
            }

            // sign in anonymously to get new uid
            await signInAnonymously(auth);

            // wait for new auth state with different uid
            return new Promise((resolve, reject) => {
                const unlisten = onAuthStateChanged(auth, (u) => {
                    if (u && u.uid && u.uid !== oldUid) {
                        unlisten();
                        resolve(u);
                    }
                }, (err) => {
                    reject(err);
                });
                setTimeout(() => {
                    try { unlisten(); } catch(e) {}
                    reject(new Error("timeout waiting for new anonymous user"));
                }, 8000);
            });
        }

        function scheduleNextSpawn() {
            if (!gameActive) return;
            const spawnRate = Math.max(200, 1000 - roundScore / 2);
            spawnTimeout = setTimeout(() => {
                if (gamePaused) { scheduleNextSpawn(); return; }
                const rand = Math.random();
                if (roundScore >= nextBossScore && !bossActive) {
                    spawnBoss();
                    nextBossScore += 500;
                } else if (rand < 0.03 && !minigameActive) {
                    spawnItem(encryptedVirusType);
                } else if (rand < 0.1) {
                    const keys = Object.keys(powerUpTypes);
                    spawnItem(powerUpTypes[keys[Math.floor(Math.random()*keys.length)]], true);
                } else {
                    spawnVirus();
                }
                scheduleNextSpawn();
            }, spawnRate);
        }

        function spawnVirus() {
            if (bossActive) return;
            const type = virusTypes[Math.floor(Math.random() * virusTypes.length)];
            spawnItem(type);
        }
        function spawnBoss() {
            bossActive = true;
            spawnItem({ ...bossType, health: bossType.maxHealth });
        }
        function spawnItem(item, isPowerUp = false) {
            const x = Math.random() * (canvas.width - (item.size||30) * 2) + (item.size||30);
            const y = - (item.size || 30);
            const angle = Math.random() * Math.PI * 0.5 + Math.PI * 0.25;
            const speed = (item.speed || 1) + (roundScore / 1000);
            const entity = {
                x, y,
                dx: Math.cos(angle) * speed * (activePowerUps['❄'] ? 0.3 : 1),
                dy: Math.sin(angle) * speed * (activePowerUps['❄'] ? 0.3 : 1),
                ...item
            };
            if (isPowerUp) powerUps.push(entity); else viruses.push(entity);
        }

        function useShield() {
            if (shieldsLeft > 0 && !isShieldOnCooldown && gameActive && !gamePaused) {
                shieldsLeft--;
                shieldsLeftEl.textContent = shieldsLeft;
                isShieldOnCooldown = true;
                shieldButton.disabled = true;
                viruses = [];
                let cooldownTime = shieldCooldown;
                const interval = setInterval(() => {
                    cooldownTime -= 100;
                    shieldCooldownOverlay.style.height = `${(cooldownTime / shieldCooldown) * 100}%`;
                    if (cooldownTime <= 0) {
                        clearInterval(interval);
                        isShieldOnCooldown = false;
                        shieldButton.disabled = false;
                        shieldCooldownOverlay.style.height = '0%';
                    }
                }, 100);
            }
        }

        function activatePowerUp(type) {
            const id = type.emoji || 'PU';
            if (activePowerUps[id]) clearTimeout(activePowerUps[id].timeout);
            if (id === '⏳') { timer += 5; timerEl.textContent = timer; return; }
            activePowerUps[id] = { duration: type.duration, expire: Date.now() + (type.duration || 0) };
            activePowerUps[id].timeout = setTimeout(() => delete activePowerUps[id], type.duration || 0);
        }

        // --- Minigame (حفظ كما هو) ---
        let minigameSequence = [], playerSequenceIndex = 0;
        function startHackingMinigame() {
            pauseGame(); minigameActive = true;
            hackingMinigameEl.classList.remove('hidden'); minigameStatusEl.textContent = '';
            const arrows = ['ArrowUp','ArrowDown','ArrowLeft','ArrowRight'];
            const symbols = { 'ArrowUp':'↑','ArrowDown':'↓','ArrowLeft':'←','ArrowRight':'→' };
            minigameSequence = Array.from({length:5}, ()=> arrows[Math.floor(Math.random()*4)]);
            playerSequenceIndex = 0;
            arrowSequenceEl.innerHTML = minigameSequence.map(k=>`<div id="key-${k}" class="arrow-key">${symbols[k]}</div>`).join('');
            window.addEventListener('keydown', handleMinigameKeys);
        }
        function handleMinigameKeys(e) {
            const key = e.key;
            if (!['ArrowUp','ArrowDown','ArrowLeft','ArrowRight'].includes(key)) return;
            const correct = minigameSequence[playerSequenceIndex];
            const el = arrowSequenceEl.children[playerSequenceIndex];
            if (key === correct) {
                el.classList.add('correct'); playerSequenceIndex++;
                if (playerSequenceIndex === minigameSequence.length) {
                    minigameStatusEl.textContent = 'تم الاختراق! +500 نقاط، +10 ثواني';
                    roundScore += 500; timer += 10;
                    scoreEl.textContent = userScore + roundScore; timerEl.textContent = timer;
                    endMinigame(true);
                }
            } else {
                el.classList.add('incorrect');
                minigameStatusEl.textContent = 'فشل الاختراق! -5 ثواني';
                timer -= 5; timerEl.textContent = timer;
                endMinigame(false);
            }
        }
        function endMinigame(success) {
            window.removeEventListener('keydown', handleMinigameKeys);
            setTimeout(()=>{ hackingMinigameEl.classList.add('hidden'); minigameStatusEl.className='text-lg h-8'; minigameActive=false; resumeGame(); }, 800);
        }

        function animate() {
            if (!gameActive) return;
            requestAnimationFrame(animate);
            if (gamePaused) return;
            ctx.clearRect(0,0,canvas.width,canvas.height);
            viruses.forEach((v,i)=> {
                v.dy = v.dy > 0 ? Math.abs(v.dy) * (activePowerUps['❄'] ? 0.3 : 1) : -Math.abs(v.dy) * (activePowerUps['❄'] ? 0.3 : 1);
                v.x += v.dx; v.y += v.dy;
                if (v.x - (v.size||20) < 0 || v.x + (v.size||20) > canvas.width) v.dx *= -1;
                if (v.y > canvas.height + (v.size||20)*2) {
                    viruses.splice(i,1);
                    if (!v.health) {
                        roundScore -= Math.floor((v.points||0) * 0.5);
                        if (roundScore < 0) roundScore = 0;
                        scoreEl.textContent = userScore + roundScore;
                    }
                }
                ctx.save();
                ctx.font = ((v.size||20) * 1.5) + "px sans-serif";
                ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
                ctx.fillText(v.emoji || '●', v.x, v.y);
                if (v.health) {
                    const w = (v.size||20)*2;
                    const h = 5; const pct = v.health / v.maxHealth;
                    ctx.fillStyle = '#333'; ctx.fillRect(v.x - w/2, v.y - (v.size||20)*1.5 - 10, w, h);
                    ctx.fillStyle = pct > 0.6 ? '#22c55e' : pct > 0.3 ? '#eab308' : '#ef4444';
                    ctx.fillRect(v.x - w/2, v.y - (v.size||20)*1.5 - 10, w * pct, h);
                }
                ctx.restore();
            });

            powerUps.forEach((p,i)=> {
                p.dy = (p.speed||1) * (activePowerUps['❄'] ? 0.3 : 1);
                p.y += p.dy;
                if (p.y - (p.size||20) > canvas.height) powerUps.splice(i,1);
                ctx.font = "30px sans-serif"; ctx.fillText(p.emoji || '★', p.x, p.y);
            });

            // particles etc omitted for brevity

            powerupStatusEl.innerHTML = '';
            for (const id in activePowerUps) {
                const remaining = Math.ceil((activePowerUps[id].expire - Date.now()) / 1000);
                powerupStatusEl.innerHTML += `<div class="bg-black bg-opacity-50 p-2 rounded-lg text-2xl">${id} ${remaining}s</div>`;
            }
        }

        function handleCanvasClick(event) {
            if (!gameActive || gamePaused) return;
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            let clientX = event.clientX, clientY = event.clientY;
            if (event.touches && event.touches[0]) { clientX = event.touches[0].clientX; clientY = event.touches[0].clientY; }
            const x = (clientX - rect.left) * scaleX;
            const y = (clientY - rect.top) * scaleY;
            const shots = activePowerUps['☄'] ? [{x,y},{x:x-20,y:y+20},{x:x+20,y:y+20}] : [{x,y}];
            shots.forEach(shot => {
                for (let i = viruses.length - 1; i >= 0; i--) {
                    const v = viruses[i];
                    const dist = Math.hypot(shot.x - v.x, shot.y - v.y);
                    if (dist < (v.size||20)) {
                        if (v.isEncrypted) { startHackingMinigame(); viruses.splice(i,1); }
                        else if (v.isGlitched) { canvas.classList.add('glitch'); setTimeout(()=>canvas.classList.remove('glitch'),2000); roundScore += v.points || 0; viruses.splice(i,1); }
                        else if (v.health) { v.health--; if (v.health<=0){ roundScore += v.points || 0; viruses.splice(i,1); bossActive=false; } }
                        else { roundScore += v.points || 0; viruses.splice(i,1); }
                        scoreEl.textContent = userScore + roundScore;
                        return;
                    }
                }
                for (let i = powerUps.length - 1; i >= 0; i--) {
                    const p = powerUps[i];
                    const dist = Math.hypot(shot.x - p.x, shot.y - p.y);
                    if (dist < 20) {
                        const typeKey = Object.keys(powerUpTypes).find(k => powerUpTypes[k].emoji === p.emoji);
                        if (typeKey) activatePowerUp(powerUpTypes[typeKey]);
                        powerUps.splice(i,1);
                        return;
                    }
                }
            });
        }

        function escapeHTML(s) { if (s == null) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;'); }
        function setCanvasDimensions() {
            const wrapper = document.getElementById('canvas-wrapper');
            const style = getComputedStyle(wrapper);
            const width = parseInt(style.width, 10) || wrapper.clientWidth;
            const height = Math.floor(width * 0.75);
            canvas.width = width;
            canvas.height = height;
        }
        function pauseGame(){ gamePaused = true; }
        function resumeGame(){ gamePaused = false; }

        // UI bindings
        window.addEventListener('resize', setCanvasDimensions);
        continueButton.addEventListener('click', startGame);

        // "ابدأ لعبة جديدة" => أنشئ UID مجهول جديد حتى لا يكتب نفس السجل
        startNewButton.addEventListener('click', async () => {
            try {
                const newUser = await createNewAnonymousUser();
                // setupAuthListener سيعمل على إنشاء doc للمستخدم الجديد
                userId = newUser.uid;
                // small delay to let setupAuthListener create doc and UI update
                await new Promise(res => setTimeout(res, 300));
                userScore = 0;
                roundScore = 0;
                updateScoreUI();
                startGame();
            } catch (err) {
                console.error("Failed to create new anonymous user:", err);
                alert("فشل إنشاء حساب جديد. حاول مرة أخرى أو افتح نافذة خاصة.");
            }
        });

        continueButtonEnd.addEventListener('click', () => { gameOverScreen.classList.add('hidden'); startGame(); });
        shieldButton.addEventListener('click', useShield);
        canvas.addEventListener('click', handleCanvasClick);
        canvas.addEventListener('touchstart', (e) => { e.preventDefault(); handleCanvasClick(e); }, { passive: false });

        setCanvasDimensions();
    </script>
</body>
</html>
